
define("infomanager",[],function(){var a=Class.extend({init:function(a){this.game=a,this.infos={},this.destroyQueue=[]},addDamageInfo:function(a,b,d,e){var f=this.game.currentTime,g=f+""+Math.abs(a)+""+b+""+d,h=this,i=new c(g,a,b,d,c.DURATION,e);i.onDestroy(function(a){h.destroyQueue.push(a)}),this.infos[g]=i},forEachInfo:function(a){var b=this;_.each(this.infos,function(b,c){a(b)})},update:function(a){var b=this;this.forEachInfo(function(b){b.update(a)}),_.each(this.destroyQueue,function(a){delete b.infos[a]}),this.destroyQueue=[]}}),b={received:{fill:"rgb(255, 50, 50)",stroke:"rgb(255, 180, 180)"},inflicted:{fill:"white",stroke:"#373737"},healed:{fill:"rgb(80, 255, 80)",stroke:"rgb(50, 120, 50)"}},c=Class.extend({DURATION:1e3,init:function(a,c,d,e,f,g){this.id=a,this.value=c,this.duration=f,this.x=d,this.y=e,this.opacity=1,this.lastTime=0,this.speed=100,this.fillColor=b[g].fill,this.strokeColor=b[g].stroke},isTimeToAnimate:function(a){return a-this.lastTime>this.speed},update:function(a){this.isTimeToAnimate(a)&&(this.lastTime=a,this.tick())},tick:function(){this.y-=1,this.opacity-=.07,this.opacity<0&&this.destroy()},onDestroy:function(a){this.destroy_callback=a},destroy:function(){this.destroy_callback&&this.destroy_callback(this.id)}});return a}),define("timer",[],function(){var a=Class.extend({init:function(a,b){this.lastTime=b||0,this.duration=a},isOver:function(a){var b=!1;a-this.lastTime>this.duration&&(b=!0,this.lastTime=a);return b}});return a}),define("bubble",["jquery","timer"],function(a,b){var c=Class.extend({init:function(a,c,d){this.id=a,this.element=c,this.timer=new b(5e3,d)},isOver:function(a){return this.timer.isOver(a)?!0:!1},destroy:function(){a(this.element).remove()},reset:function(a){this.timer.lastTime=a}}),d=Class.extend({init:function(a){this.container=a,this.bubbles={}},getBubbleById:function(a){return a in this.bubbles?this.bubbles[a]:null},create:function(b,d,e){if(this.bubbles[b])this.bubbles[b].reset(e),a("#"+b+" p").html(d);else{var f=a('<div id="'+b+'" class="bubble"><p>'+d+'</p><div class="thingy"></div></div>');a(f).appendTo(this.container),this.bubbles[b]=new c(b,f,e)}},update:function(a){var b=this,c=[];_.each(this.bubbles,function(b){b.isOver(a)&&(b.destroy(),c.push(b.id))}),_.each(c,function(a){delete b.bubbles[a]})},clean:function(){var a=this,b=[];_.each(this.bubbles,function(a){a.destroy(),b.push(a.id)}),_.each(b,function(b){delete a.bubbles[b]}),this.bubbles={}},destroyBubble:function(a){var b=this.getBubbleById(a);b&&(b.destroy(),delete this.bubbles[a])},forEachBubble:function(a){_.each(this.bubbles,function(b){a(b)})}});return d}),define("camera",[],function(){var a=Class.extend({init:function(a){this.renderer=a,this.x=0,this.y=0,this.gridX=0,this.gridY=0,this.offset=.5,this.rescale()},rescale:function(){var a=this.renderer.mobile?1:2;this.gridW=15*a,this.gridH=7*a,log.debug("---------"),log.debug("Factor:"+a),log.debug("W:"+this.gridW+" H:"+this.gridH)},setPosition:function(a,b){this.x=a,this.y=b,this.gridX=Math.floor(a/16),this.gridY=Math.floor(b/16)},setGridPosition:function(a,b){this.gridX=a,this.gridY=b,this.x=this.gridX*16,this.y=this.gridY*16},lookAt:function(a){var b=this.renderer,c=Math.round(a.x-Math.floor(this.gridW/2)*b.tilesize),d=Math.round(a.y-Math.floor(this.gridH/2)*b.tilesize);this.setPosition(c,d)},forEachVisiblePosition:function(a,b){var b=b||0;for(var c=this.gridY-b,d=this.gridY+this.gridH+b*2;c<d;c+=1)for(var e=this.gridX-b,f=this.gridX+this.gridW+b*2;e<f;e+=1)a(e,c)},isVisible:function(a){return this.isVisiblePosition(a.gridX,a.gridY)},isVisiblePosition:function(a,b){return b>=this.gridY&&b<this.gridY+this.gridH&&a>=this.gridX&&a<this.gridX+this.gridW?!0:!1},focusEntity:function(a){var b=this.gridW-2,c=this.gridH-2,d=Math.floor((a.gridX-1)/b)*b,e=Math.floor((a.gridY-1)/c)*c;this.setGridPosition(d,e)}});return a}),define("entity",[],function(){var a=Class.extend({init:function(a,b){var c=this;this.id=a,this.kind=b,this.sprite=null,this.flipSpriteX=!1,this.flipSpriteY=!1,this.animations=null,this.currentAnimation=null,this.shadowOffsetY=0,this.setGridPosition(0,0),this.isLoaded=!1,this.isHighlighted=!1,this.visible=!0,this.isFading=!1,this.setDirty()},setName:function(a){this.name=a},setPosition:function(a,b){this.x=a,this.y=b},setGridPosition:function(a,b){this.gridX=a,this.gridY=b,this.setPosition(a*16,b*16)},setSprite:function(a){if(!a){log.error(this.id+" : sprite is null",!0);throw"Sprite error"}if(!this.sprite||this.sprite.name!==a.name){this.sprite=a,this.normalSprite=this.sprite;if(Types.isMob(this.kind)||Types.isPlayer(this.kind))this.hurtSprite=a.getHurtSprite();this.animations=a.createAnimations(),this.isLoaded=!0,this.ready_func&&this.ready_func()}},getSprite:function(){return this.sprite},getSpriteName:function(){return Types.getKindAsString(this.kind)},getAnimationByName:function(a){var b=null;a in this.animations?b=this.animations[a]:log.error("No animation called "+a);return b},setAnimation:function(a,b,c,d){var e=this;if(t...d=this.camera,e=this.renderer.tilesize,a=d.x,b=d.y,f=(d.gridW-2)*e,g=(d.gridH-2)*e;if(c===Types.Orientations.LEFT||c===Types.Orientations.RIGHT)a=c===Types.Orientations.LEFT?d.x-f:d.x+f;else if(c===Types.Orientations.UP||c===Types.Orientations.DOWN)b=c===Types.Orientations.UP?d.y-g:d.y+g;d.setPosition(a,b),this.renderer.clearScreen(this.renderer.context),this.endZoning(),this.forEachVisibleEntityByDepth(function(a){a.setDirty()})}else this.currentZoning=new l;this.bubbleManager.clean(),this.client.sendZone()},enqueueZoningFrom:function(a,b){this.zoningQueue.push({x:a,y:b}),this.zoningQueue.length===1&&this.startZoningFrom(a,b)},endZoning:function(){this.currentZoning=null,this.resetZone(),this.zoningQueue.shift();if(this.zoningQueue.length>0){var a=this.zoningQueue[0];this.startZoningFrom(a.x,a.y)}},isZoning:function(){return!_.isNull(this.currentZoning)},resetZone:function(){this.bubbleManager.clean(),this.initAnimatedTiles(),this.renderer.renderStaticCanvases()},resetCamera:function(){this.camera.focusEntity(this.player),this.resetZone()},say:function(a){this.client.sendChat(a)},createBubble:function(a,b){this.bubbleManager.create(a,b,this.currentTime)},destroyBubble:function(a){this.bubbleManager.destroyBubble(a)},assignBubbleTo:function(a){var b=this.bubbleManager.getBubbleById(a.id);if(b){var c=this.renderer.scale,d=16*c,e=(a.x-this.camera.x)*c,f=parseInt(b.element.css("width"))+24,g=f/2-d/2,h,i;a instanceof p?h=0:c===2?this.renderer.mobile?h=0:h=15:h=12,i=(a.y-this.camera.y)*c-d*2-h,b.element.css("left",e-g+"px"),b.element.css("top",i+"px")}},restart:function(){log.debug("Beginning restart"),this.entities={},this.initEntityGrid(),this.initPathingGrid(),this.initRenderingGrid(),this.player=new h("player",this.username),this.initPlayer(),this.started=!0,this.client.enable(),this.sendHello(this.player),this.storage.incrementRevives(),(this.renderer.mobile||this.renderer.tablet)&&this.renderer.clearScreen(this.renderer.context),log.debug("Finished restart")},onGameStart:function(a){this.gamestart_callback=a},onDisconnect:function(a){this.disconnect_callback=a},onPlayerDeath:function(a){this.playerdeath_callback=a},onPlayerHealthChange:function(a){this.playerhp_callback=a},onPlayerHurt:function(a){this.playerhurt_callback=a},onPlayerEquipmentChange:function(a){this.equipment_callback=a},onNbPlayersChange:function(a){this.nbplayers_callback=a},onNotification:function(a){this.notification_callback=a},onPlayerInvincible:function(a){this.invincible_callback=a},resize:function(){var a=this.camera.x,b=this.camera.y,c=this.renderer.scale,d=this.renderer.getScaleFactor();this.renderer.rescale(d),this.camera=this.renderer.camera,this.camera.setPosition(a,b),this.renderer.renderStaticCanvases()},updateBars:function(){this.player&&this.playerhp_callback&&this.playerhp_callback(this.player.hitPoints,this.player.maxHitPoints)},getDeadMobPosition:function(a){var b;a in this.deathpositions&&(b=this.deathpositions[a],delete this.deathpositions[a]);return b},onAchievementUnlock:function(a){this.unlock_callback=a},tryUnlockingAchievement:function(a){var b=null;a in this.achievements&&(b=this.achievements[a],b.isCompleted()&&this.storage.unlockAchievement(b.id)&&this.unlock_callback&&(this.unlock_callback(b.id,b.name,b.desc),this.audioManager.playSound("achievement")))},showNotification:function(a){this.notification_callback&&this.notification_callback(a)},removeObsoleteEntities:function(){var a=_.size(this.obsoleteEntities),b=this;a>0&&(_.each(this.obsoleteEntities,function(a){a.id!=b.player.id&&b.removeEntity(a)}),log.debug("Removed "+a+" entities: "+_.pluck(_.reject(this.obsoleteEntities,function(a){return a===b.player.id}),"id")),this.obsoleteEntities=null)},updateCursor:function(){this.movecursor(),this.updateCursorLogic()},updatePlateauMode:function(){this.map.isPlateau(this.player.gridX,this.player.gridY)?this.player.isOnPlateau=!0:this.player.isOnPlateau=!1},updatePlayerCheckpoint:function(){var a=this.map.getCurrentCheckpoint(this.player);if(a){var b=this.player.lastCheckpoint;if(!b||b&&b.id!==a.id)this.player.lastCheckpoint=a,this.client.sendCheck(a.id)}},checkUndergroundAchievement:function(){var a=this.audioManager.getSurroundingMusic(this.player);a&&a.name==="cave"&&this.tryUnlockingAchievement("UNDERGROUND")},forEachEntityAround:function(a,b,c,d){for(var e=a-c,f=a+c;e<=f;e+=1)for(var g=b-c,h=b+c;g<=h;g+=1)this.map.isOutOfBounds(e,g)||_.each(this.renderingGrid[g][e],function(a){d(a)})},checkOtherDirtyRects:function(a,b,c,d){var e=this.renderer;this.forEachEntityAround(c,d,2,function(c){if(!b||!b.id||c.id!==b.id)if(!c.isDirty){var d=e.getEntityBoundingRect(c);e.isIntersecting(a,d)&&c.setDirty()}}),b&&!b.hasOwnProperty("index")&&this.forEachAnimatedTile(function(b){if(!b.isDirty){var c=e.getTileBoundingRect(b);e.isIntersecting(a,c)&&(b.isDirty=!0)}});if(!this.drawTarget&&this.selectedCellVisible){var f=e.getTargetBoundingRect();e.isIntersecting(a,f)&&(this.drawTarget=!0,this.renderer.targetRect=f)}}});return w})
